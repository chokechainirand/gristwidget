<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Chart</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-base.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-ui.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-exports.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-stock.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-data-adapter.min.js"></script>
    <script src="https://cdn.anychart.com/csv-data/msft-daily-short-data(2011-2016).js"></script>
    <script src="https://cdn.anychart.com/releases/v8/themes/dark_turquoise.min.js"></script>
    <link href="https://cdn.anychart.com/releases/v8/css/anychart-ui.min.css" type="text/css" rel="stylesheet">
    <link href="https://cdn.anychart.com/releases/v8/fonts/css/anychart-font.min.css" type="text/css" rel="stylesheet">
    <style type="text/css">
        html,
        body,
        #container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>
    version 3
    <pre id="readout">Waiting for data...</pre>
    <div id="container"></div>

    <script>
        let datamap = '';
        let aa = [];
        grist.ready();



        anychart.onDocumentReady(function () {

            grist.onRecords(function (records) {
                data = JSON.stringify(records, null, 2);
                datamap = JSON.parse(data)




            });




            var dataTable = anychart.data.table();
            Object.keys(datamap).forEach(function (e) {

                aa.push(
                    [
                        datamap[e]['time'],
                        datamap[e]['c1_percent'],
                        datamap[e]['high24hr'],
                        datamap[e]['low24hr'],
                        datamap[e]['vd'],
                        datamap[e]['last'],
                        datamap[e]['quoteVolume'],

                    ]);
            });
            document.getElementById('readout').innerHTML = aa;

            dataTable.addData(aa);

            // create stock chart
            var chart = anychart.stock();
            var title = chart.title();
            title.enabled(true);
            //title.text(datamap[0]['coin']);
            chart.tooltip().fontColor("gold");
            chart.tooltip().format(
                "{%seriesName}: {%value}{thousandsSeparator:'',scale:(1000)(1000)(1000)|(k)(m)(b),numDecimals:4,trailingZeros:false}");

            chart.padding().right(60);
            c1 = chart.plot(0);
            c1.yAxis().orientation('right');
            c1.legend().enabled(true);
            //c1.xGrid(true).yGrid(true);
            c1.line(dataTable.mapAs({ value: 5 })).name('Last').stroke("#157AFB", 2.5, "6 0");

            c1.line(dataTable.mapAs({ value: 1 })).name('1%').stroke("#E00A17", 1, "6 0");
            c1.line(dataTable.mapAs({ value: 2 })).name('high').stroke("#FD9D28", 1, "6 0");
            c1.line(dataTable.mapAs({ value: 3 })).name('low').stroke("#2AE028", 1, "6 0");
            c1.sma(dataTable.mapAs({ value: 5 }), 3).series().name('SMA').stroke("#157AFB", 1, "6 4");

            var indicator = c1.priceIndicator().value('series-end').stroke("#E1518F", 1, "4 2")
            indicator.label().background().fill("#E1518F .8");
            indicator.label().fontColor("white")

            var volumeSeries = c1.column(dataTable.mapAs({ value: 6 }));
            volumeSeries.name('Volume').zIndex(100).maxHeight('20%').bottom(0);
            volumeSeries.legendItem({
                iconEnabled: false,
                textOverflow: ''
            });

            //volumeSeries.yAxis().labels().format('${%Value}{scale:(1000000)(1000)|(kk)(k)}');

            volumeSeries.yScale(anychart.scales.log());
            volumeSeries.stroke('#126E0E .1').risingStroke('#126E0E .8').fallingStroke('#740206 .2');
            volumeSeries.fill('#126E0E .2').risingFill('#126E0E .8').fallingFill('#740206 .2');

            chart.container('container');
            chart.draw();

            chart.background().fill("#373540")

        });




    //console.log(datamap)



    </script>
</body>

</html>